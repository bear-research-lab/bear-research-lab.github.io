{%- comment -%}
pub-item.html — renders one publication with exactly four buttons:
Paper | BibTeX | Press* | Links*
*Press and Links appear only if there is data.
Expected data schema (flexible):
links:
paper: "https://..."
bibtex: | # can be string or multiline block
@inproceedings{...}
press:
- { title: "MIT News", url: "https://..." }
- { title: "TechCrunch", url: "https://..." }
# Any other keys (video, code, dataset, poster, slides, repo, demo, project, etc.)
# are auto-rolled under "Links".
{%- endcomment -%}

{%- assign p = include.pub -%}
{%- assign uid = p.title | append: '-' | append: p.year | slugify -%}
{%- assign topics_csv = p.topics | join: ',' -%}
{%- assign links = p.links -%}

{%- comment -%} Normalize core links {%- endcomment -%}
{%- assign link_paper = links.paper | to_s | strip -%}
{%- assign link_bibtex = links.bibtex | to_s | strip -%}
{%- assign has_bibtex = link_bibtex != "" -%}

{%- comment -%} Press can be a string OR a list [{title,url}] {%- endcomment -%}
{%- assign has_press = false -%}
{%- if links.press -%}
{%- if links.press.first and links.press.first.title -%}
{%- assign has_press = true -%}
{%- elsif links.press contains 'http' -%}
{%- assign has_press = true -%}
{%- endif -%}
{%- endif -%}

{%- comment -%}
Collect “extras” (unknown link keys) for the Links drawer.
Keys treated as “known”: paper, bibtex, press.
Everything else under links.* becomes a Links item.
Supports:
- Scalar string URL -> label is the key name (title-cased)
- Object {title, url}
- List of either form
{%- endcomment -%}
{%- assign known = "paper|bibtex|press" | split:"|" -%}
{%- assign extras_exist = false -%}

{%- capture extras_html -%}
<ul class="pub-links-list">
    {%- for kv in links -%}
    {%- assign k = kv[0] | to_s | strip -%}
    {%- assign v = kv[1] -%}
    {%- unless known contains k -%}
    {%- assign extras_exist = true -%}
    {%- if v contains 'http' and v.size > 0 and v.first == nil -%}
    <li><a href="{{ v }}" target="_blank" rel="noopener">{{ k | replace: '_',' ' | replace: '-',' ' | capitalize }}</a>
    </li>
    {%- elsif v.first and v.first.title -%}
    {%- for it in v -%}
    <li><a href="{{ it.url }}" target="_blank" rel="noopener">{{ it.title }}</a></li>
    {%- endfor -%}
    {%- elsif v.first and v.first contains 'http' -%}
    {%- for it in v -%}
    <li><a href="{{ it }}" target="_blank" rel="noopener">{{ k | replace: '_',' ' | replace: '-',' ' | capitalize }} {{
            forloop.index }}</a></li>
    {%- endfor -%}
    {%- elsif v.url -%}
    <li><a href="{{ v.url }}" target="_blank" rel="noopener">{{ v.title | default: k | capitalize }}</a></li>
    {%- endif -%}
    {%- endunless -%}
    {%- endfor -%}
</ul>
{%- endcapture -%}

<div class="pub-item" data-year="{{ p.year }}" data-topics="{{ topics_csv }}"
    data-kind="{{ p.kind | downcase | default: 'others' }}" data-selected="{{ p.selected | default: false }}">

    {%- if p.img -%}
    <img class="pub-thumb" src="{{ p.img | relative_url }}" alt="{{ p.title | escape }}">
    {%- endif -%}

    <div class="pub-body">
        <div class="pub-headline">
            <div class="pub-title"><strong>{{ p.title }}</strong></div>
            <div class="pub-authors">{{ p.authors }}</div>
            <div class="pub-venue">
                {%- if p.venue -%}{{ p.venue }}{%- endif -%}
                {%- if p.venue -%} {% endif -%}{%- if p.year -%}{{, p.year }}
                {%- endif -%}
            </div>
        </div>

        <div class="pub-actions" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;">
            {%- if link_paper != "" -%}
            <a class="pub-btn" href="{{ link_paper }}" target="_blank" rel="noopener">Paper</a>
            {%- endif -%}

            {%- if has_bibtex -%}
            <a class="pub-btn toggle-bibtex" href="#" data-target="bibtex-{{ uid }}">BibTeX</a>
            {%- endif -%}

            {%- if has_press -%}
            <a class="pub-btn toggle-press" href="#" data-target="press-{{ uid }}">Press</a>
            {%- endif -%}

            {%- if extras_html contains '<li>' -%}
                <a class="pub-btn toggle-links" href="#" data-target="links-{{ uid }}">Links</a>
                {%- endif -%}
        </div>

        {%- if has_bibtex -%}
        <div id="bibtex-{{ uid }}" class="pub-bibtex" aria-hidden="true" style="margin-top:8px;">
            <pre style="white-space:pre-wrap;"><code>{{ link_bibtex }}</code></pre>
        </div>
        {%- endif -%}

        {%- if has_press -%}
        <div id="press-{{ uid }}" class="pub-press" aria-hidden="true" style="margin-top:8px;">
            <ul class="pub-press-list">
                {%- if links.press.first and links.press.first.title -%}
                {%- for pr in links.press -%}
                <li><a href="{{ pr.url }}" target="_blank" rel="noopener">{{ pr.title }}</a></li>
                {%- endfor -%}
                {%- else -%}
                <li><a href="{{ links.press }}" target="_blank" rel="noopener">Press</a></li>
                {%- endif -%}
            </ul>
        </div>
        {%- endif -%}

        {%- if extras_html contains '<li>' -%}
            <div id="links-{{ uid }}" class="pub-links" aria-hidden="true" style="margin-top:8px;">
                {{ extras_html }}
            </div>
            {%- endif -%}
    </div>
</div>